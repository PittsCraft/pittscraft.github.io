<!DOCTYPE html>
<html lang="fr">
    <head prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#">
    <meta charset="UTF-8" />

    <meta name="generator" content="Hugo 0.80.0" /><meta name="theme-color" content="#fff" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
    <meta name="format-detection" content="telephone=no, date=no, address=no, email=no" />
    
    <meta http-equiv="Cache-Control" content="no-transform" />
    
    <meta http-equiv="Cache-Control" content="no-siteapp" />

    <title>SwiftUI &amp; Combine Feedback #2 : property wrapper pour UserDefaults et @Published | Pitt&#39;s Craft</title>

    <link rel="stylesheet" href="/css/meme.min.f9894a4a4e2059037165836b72caba3584b7eddf447230427071d466c3bdd7ab.css"/>

    
    
        <script src="https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/lunr-languages@1.4.0/min/lunr.stemmer.support.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/lunr-languages@1.4.0/min/lunr.fr.min.js" defer></script><script src="/js/meme.min.2e8cecdb28365acb51546c474e04cc3d1566d483eb8370d97ec4daebeaec1398.js"></script>

    

    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />

        <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=IBM&#43;Plex&#43;Serif:ital,wght@0,400;0,500;0,700;1,400;1,700&amp;family=Source&#43;Code&#43;Pro:ital,wght@0,400;0,700;1,400;1,700&amp;family=Comfortaa:wght@700&amp;display=swap" media="print" onload="this.media='all'" />
        <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=IBM&#43;Plex&#43;Serif:ital,wght@0,400;0,500;0,700;1,400;1,700&amp;family=Source&#43;Code&#43;Pro:ital,wght@0,400;0,700;1,400;1,700&amp;family=Comfortaa:wght@700&amp;display=swap" /></noscript>

    <meta name="author" content="Pitt" /><meta name="description" content="J’avais déjà croisé un exemple d’implémentation de property wrapper et devant leur simplicité, je m’étais mis en tête de créer un property wrapper accélérant le stockage de valeurs dans les UserDefaults.
Il se trouve que dans mes expérimentations autour de Combine j’avais bien envie de créer un wrapper publiant les nouvelles valeurs seulement après les avoirs stockées (voir ici)." />

    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="mask-icon" href="/icons/safari-pinned-tab.svg" color="#2a6df4" />
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon.png" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-title" content="Pitt&#39;s Craft" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="application-name" content="Pitt&#39;s Craft" />
    <meta name="msapplication-starturl" content="../../" />
    <meta name="msapplication-TileColor" content="#fff" />
    <meta name="msapplication-TileImage" content="../../icons/mstile-150x150.png" />
    <link rel="manifest" href="/manifest.json" />

    
    

    
    <link rel="canonical" href="https://pittscraft.com/posts/swiftui_combine2/" />
    

<script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "BlogPosting",
        "datePublished": "2020-12-10T14:14:35+01:00",
        "dateModified": "2020-12-10T14:14:35+01:00",
        "url": "https://pittscraft.com/posts/swiftui_combine2/",
        "headline": "SwiftUI \u0026 Combine Feedback #2 : property wrapper pour UserDefaults et @Published",
        "description": "J’avais déjà croisé un exemple d’implémentation de property wrapper et devant leur simplicité, je m’étais mis en tête de créer un property wrapper accélérant le stockage de valeurs dans les UserDefaults.\nIl se trouve que dans mes expérimentations autour de Combine j’avais bien envie de créer un wrapper publiant les nouvelles valeurs seulement après les avoirs stockées (voir ici).",
        "inLanguage" : "fr",
        "articleSection": "posts",
        "wordCount":  3362 ,
        "image": "https://pittscraft.com/icons/apple-touch-icon.png",
        "author": {
            "@type": "Person",
            "email": "pitt@pittscraft.com",
            "image": "https://pittscraft.com/icons/apple-touch-icon.png",
            "url": "https://pittscraft.com/about/",
            "name": "Pitt"
        },
        "publisher": {
            "@type": "Organization",
            "name": "Pitt's Craft",
            "logo": {
                "@type": "ImageObject",
                "url": "https://pittscraft.com/icons/apple-touch-icon.png"
            },
            "url": "https://pittscraft.com/"
        },
        "mainEntityOfPage": {
            "@type": "WebSite",
            "@id": "https://pittscraft.com/"
        }
    }
</script>

    

<meta name="twitter:card" content="summary" />

<meta name="twitter:site" content="@reuixiy" />

    



<meta property="og:title" content="SwiftUI &amp; Combine Feedback #2 : property wrapper pour UserDefaults et @Published" />
<meta property="og:description" content="J’avais déjà croisé un exemple d’implémentation de property wrapper et devant leur simplicité, je m’étais mis en tête de créer un property wrapper accélérant le stockage de valeurs dans les UserDefaults.
Il se trouve que dans mes expérimentations autour de Combine j’avais bien envie de créer un wrapper publiant les nouvelles valeurs seulement après les avoirs stockées (voir ici)." />
<meta property="og:url" content="https://pittscraft.com/posts/swiftui_combine2/" />
<meta property="og:site_name" content="Pitt&#39;s Craft" />
<meta property="og:locale" content="fr" /><meta property="og:image" content="https://pittscraft.com/icons/apple-touch-icon.png" />
    <meta property="og:type" content="article" />
    <meta property="article:published_time" content="2020-12-10T14:14:35&#43;01:00" />
    <meta property="article:modified_time" content="2020-12-10T14:14:35&#43;01:00" />
    
    <meta property="article:section" content="posts" />



    
</head>

    <body>
        <div class="container">
            
    <header class="header">
        
            <div class="header-wrapper">
                <div class="header-inner single">
                    
    <div class="site-brand">
        
            <a href="/" class="brand">Pitt&#39;s Craft</a>
        
    </div>

                    <nav class="nav">
    <ul class="menu" id="menu">
        
            
        
        
        
        
            
                <li class="menu-item"><a href="/posts/"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon archive"><path d="M32 448c0 17.7 14.3 32 32 32h384c17.7 0 32-14.3 32-32V160H32v288zm160-212c0-6.6 5.4-12 12-12h104c6.6 0 12 5.4 12 12v8c0 6.6-5.4 12-12 12H204c-6.6 0-12-5.4-12-12v-8zM480 32H32C14.3 32 0 46.3 0 64v48c0 8.8 7.2 16 16 16h480c8.8 0 16-7.2 16-16V64c0-17.7-14.3-32-32-32z"/></svg><span class="menu-item-name">Posts</span></a>
                </li>
            
        
            
                <li class="menu-item"><a href="/categories/"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon th"><path d="M149.333 56v80c0 13.255-10.745 24-24 24H24c-13.255 0-24-10.745-24-24V56c0-13.255 10.745-24 24-24h101.333c13.255 0 24 10.745 24 24zm181.334 240v-80c0-13.255-10.745-24-24-24H205.333c-13.255 0-24 10.745-24 24v80c0 13.255 10.745 24 24 24h101.333c13.256 0 24.001-10.745 24.001-24zm32-240v80c0 13.255 10.745 24 24 24H488c13.255 0 24-10.745 24-24V56c0-13.255-10.745-24-24-24H386.667c-13.255 0-24 10.745-24 24zm-32 80V56c0-13.255-10.745-24-24-24H205.333c-13.255 0-24 10.745-24 24v80c0 13.255 10.745 24 24 24h101.333c13.256 0 24.001-10.745 24.001-24zm-205.334 56H24c-13.255 0-24 10.745-24 24v80c0 13.255 10.745 24 24 24h101.333c13.255 0 24-10.745 24-24v-80c0-13.255-10.745-24-24-24zM0 376v80c0 13.255 10.745 24 24 24h101.333c13.255 0 24-10.745 24-24v-80c0-13.255-10.745-24-24-24H24c-13.255 0-24 10.745-24 24zm386.667-56H488c13.255 0 24-10.745 24-24v-80c0-13.255-10.745-24-24-24H386.667c-13.255 0-24 10.745-24 24v80c0 13.255 10.745 24 24 24zm0 160H488c13.255 0 24-10.745 24-24v-80c0-13.255-10.745-24-24-24H386.667c-13.255 0-24 10.745-24 24v80c0 13.255 10.745 24 24 24zM181.333 376v80c0 13.255 10.745 24 24 24h101.333c13.255 0 24-10.745 24-24v-80c0-13.255-10.745-24-24-24H205.333c-13.255 0-24 10.745-24 24z"/></svg><span class="menu-item-name">Categories</span></a>
                </li>
            
        
            
                <li class="menu-item"><a href="/tags/"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512" class="icon tags"><path d="M497.941 225.941L286.059 14.059A48 48 0 0 0 252.118 0H48C21.49 0 0 21.49 0 48v204.118a48 48 0 0 0 14.059 33.941l211.882 211.882c18.744 18.745 49.136 18.746 67.882 0l204.118-204.118c18.745-18.745 18.745-49.137 0-67.882zM112 160c-26.51 0-48-21.49-48-48s21.49-48 48-48 48 21.49 48 48-21.49 48-48 48zm513.941 133.823L421.823 497.941c-18.745 18.745-49.137 18.745-67.882 0l-.36-.36L527.64 323.522c16.999-16.999 26.36-39.6 26.36-63.64s-9.362-46.641-26.36-63.64L331.397 0h48.721a48 48 0 0 1 33.941 14.059l211.882 211.882c18.745 18.745 18.745 49.137 0 67.882z"/></svg><span class="menu-item-name">Tags</span></a>
                </li>
            
        
            
                <li class="menu-item"><a href="/about/"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512" class="icon user-circle"><path d="M248 8C111 8 0 119 0 256s111 248 248 248 248-111 248-248S385 8 248 8zm0 96c48.6 0 88 39.4 88 88s-39.4 88-88 88-88-39.4-88-88 39.4-88 88-88zm0 344c-58.7 0-111.3-26.6-146.5-68.2 18.8-35.4 55.6-59.8 98.5-59.8 2.4 0 4.8.4 7.1 1.1 13 4.2 26.6 6.9 40.9 6.9 14.3 0 28-2.7 40.9-6.9 2.3-.7 4.7-1.1 7.1-1.1 42.9 0 79.7 24.4 98.5 59.8C359.3 421.4 306.7 448 248 448z"/></svg><span class="menu-item-name">About</span></a>
                </li>
            
        
            
                <li class="menu-item"><a href=""></a>
                </li>
            
        
            
                
            
        
            
                <li class="menu-item search-item">
                        <form id="search" class="search" role="search">
    <label for="search-input"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon search-icon"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></label>
    <input type="search" id="search-input" class="search-input">
</form>

<template id="search-result" hidden>
    <article class="content post">
        <h2 class="post-title"><a class="summary-title-link"></a></h2>
        <summary class="summary"></summary>
        <div class="read-more-container">
            <a class="read-more-link">Lire Plus »</a>
        </div>
    </article>
</template>

                    </li>
                
            
        
    </ul>
</nav>

                    
                </div>
            </div>
            
    <input type="checkbox" id="nav-toggle" aria-hidden="true" />
    <label for="nav-toggle" class="nav-toggle"></label>
    <label for="nav-toggle" class="nav-curtain"></label>


        
    </header>




            
            
    <main class="main single" id="main">
    <div class="main-inner">

        

        <article class="content post h-entry" data-small-caps="true" data-align="default" data-type="posts" data-toc-num="true">

            <h1 class="post-title p-name">SwiftUI &amp; Combine Feedback #2 : property wrapper pour UserDefaults et @Published</h1>

            

            
                
            

            
                

<div class="post-meta">
    
        
        <time datetime="2020-12-10T14:14:35&#43;01:00" class="post-meta-item published dt-published"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon post-meta-icon"><path d="M148 288h-40c-6.6 0-12-5.4-12-12v-40c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v40c0 6.6-5.4 12-12 12zm108-12v-40c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12zm96 0v-40c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12zm-96 96v-40c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12zm-96 0v-40c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12zm192 0v-40c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12zm96-260v352c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V112c0-26.5 21.5-48 48-48h48V12c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v52h128V12c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v52h48c26.5 0 48 21.5 48 48zm-48 346V160H48v298c0 3.3 2.7 6 6 6h340c3.3 0 6-2.7 6-6z"/></svg>&nbsp;10.12.2020</time>
    
    
        
        <time datetime="2020-12-10T14:14:35&#43;01:00" class="post-meta-item modified dt-updated"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon post-meta-icon"><path d="M400 64h-48V12c0-6.627-5.373-12-12-12h-40c-6.627 0-12 5.373-12 12v52H160V12c0-6.627-5.373-12-12-12h-40c-6.627 0-12 5.373-12 12v52H48C21.49 64 0 85.49 0 112v352c0 26.51 21.49 48 48 48h352c26.51 0 48-21.49 48-48V112c0-26.51-21.49-48-48-48zm-6 400H54a6 6 0 0 1-6-6V160h352v298a6 6 0 0 1-6 6zm-52.849-200.65L198.842 404.519c-4.705 4.667-12.303 4.637-16.971-.068l-75.091-75.699c-4.667-4.705-4.637-12.303.068-16.971l22.719-22.536c4.705-4.667 12.303-4.637 16.97.069l44.104 44.461 111.072-110.181c4.705-4.667 12.303-4.637 16.971.068l22.536 22.718c4.667 4.705 4.636 12.303-.069 16.97z"/></svg>&nbsp;10.12.2020</time>
    
    
    
        
        
        
            
                <span class="post-meta-item category"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon post-meta-icon"><path d="M464 128H272l-54.63-54.63c-6-6-14.14-9.37-22.63-9.37H48C21.49 64 0 85.49 0 112v288c0 26.51 21.49 48 48 48h416c26.51 0 48-21.49 48-48V176c0-26.51-21.49-48-48-48zm0 272H48V112h140.12l54.63 54.63c6 6 14.14 9.37 22.63 9.37H464v224z"/></svg>&nbsp;<a href="/categories/application-mobile/" class="category-link p-category">Application mobile</a></span>
            
        
    
    
        
        <span class="post-meta-item wordcount"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon post-meta-icon"><path d="M497.9 142.1l-46.1 46.1c-4.7 4.7-12.3 4.7-17 0l-111-111c-4.7-4.7-4.7-12.3 0-17l46.1-46.1c18.7-18.7 49.1-18.7 67.9 0l60.1 60.1c18.8 18.7 18.8 49.1 0 67.9zM284.2 99.8L21.6 362.4.4 483.9c-2.9 16.4 11.4 30.6 27.8 27.8l121.5-21.3 262.6-262.6c4.7-4.7 4.7-12.3 0-17l-111-111c-4.8-4.7-12.4-4.7-17.1 0zM124.1 339.9c-5.5-5.5-5.5-14.3 0-19.8l154-154c5.5-5.5 14.3-5.5 19.8 0s5.5 14.3 0 19.8l-154 154c-5.5 5.5-14.3 5.5-19.8 0zM88 424h48v36.3l-64.5 11.3-31.1-31.1L51.7 376H88v48z"/></svg>&nbsp;3362</span>
    
    
        
        <span class="post-meta-item reading-time"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon post-meta-icon"><path d="M256 8C119 8 8 119 8 256s111 248 248 248 248-111 248-248S393 8 256 8zm0 448c-110.5 0-200-89.5-200-200S145.5 56 256 56s200 89.5 200 200-89.5 200-200 200zm61.8-104.4l-84.9-61.7c-3.1-2.3-4.9-5.9-4.9-9.7V116c0-6.6 5.4-12 12-12h32c6.6 0 12 5.4 12 12v141.7l66.8 48.6c5.4 3.9 6.5 11.4 2.6 16.8L334.6 349c-3.9 5.3-11.4 6.5-16.8 2.6z"/></svg>&nbsp;16&nbsp;min.</span>
    
    
    
</div>

            

            <div class="post-body e-content">
              <p style="text-indent:0"><span class="drop-cap">J</span>&rsquo;avais déjà croisé un exemple d&rsquo;implémentation de property wrapper et devant leur simplicité, je m&rsquo;étais mis en tête de créer un property wrapper accélérant le stockage de valeurs dans les <code>UserDefaults</code>.</p>
<p>Il se trouve que dans mes expérimentations autour de <code>Combine</code> j&rsquo;avais bien envie de créer un wrapper publiant les nouvelles valeurs seulement après les avoirs stockées (<a href="/posts/swiftui_combine1">voir ici</a>).</p>
<p>Et puis j&rsquo;ai finalement voulu faire tout en même temps !</p>
<h2 id="quest-ce-donc-quun-property-wrapper-"><a href="#quest-ce-donc-quun-property-wrapper-" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>Qu&rsquo;est-ce donc qu&rsquo;un property wrapper ?</h2>
<p>Un property wrapper très simple s&rsquo;écrit de cette manière :</p>
<div class="highlight"><pre class="chroma"><code class="language-swift" data-lang="swift"><span class="p">@</span><span class="n">propertyWrapper</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Print</span><span class="p">&lt;</span><span class="n">Value</span><span class="p">&gt;</span> <span class="p">{</span><span class="n">ss</span>
    <span class="kd">private</span> <span class="kd">var</span> <span class="nv">val</span><span class="p">:</span> <span class="n">Value</span>
    
    <span class="kd">public</span> <span class="kd">init</span><span class="p">(</span><span class="n">wrappedValue</span> <span class="n">value</span><span class="p">:</span> <span class="n">Value</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">val</span> <span class="p">=</span> <span class="n">value</span>
    <span class="p">}</span>
    
    <span class="kd">public</span> <span class="kd">var</span> <span class="nv">wrappedValue</span><span class="p">:</span> <span class="n">Value</span> <span class="p">{</span>
        <span class="kr">set</span> <span class="p">{</span>
            <span class="bp">print</span><span class="p">(</span><span class="s">&#34;Setting &#39;</span><span class="si">\(</span><span class="n">val</span><span class="si">)</span><span class="s">&#39;&#34;</span><span class="p">)</span>
            <span class="n">val</span> <span class="p">=</span> <span class="n">newValue</span>
        <span class="p">}</span>
        <span class="kr">get</span> <span class="p">{</span> 
            <span class="bp">print</span><span class="p">(</span><span class="s">&#34;Returning &#39;</span><span class="si">\(</span><span class="n">val</span><span class="si">)</span><span class="s">&#39;&#34;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">val</span> 
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>et s&rsquo;utilise ensuite ainsi :</p>
<div class="highlight"><pre class="chroma"><code class="language-swift" data-lang="swift"><span class="kd">class</span> <span class="nc">SomeClass</span> <span class="p">{</span>
 <span class="p">@</span><span class="n">Print</span>
 <span class="kd">var</span> <span class="nv">myString</span><span class="p">:</span> <span class="nb">String</span> <span class="p">=</span> <span class="s">&#34;Coucou copaing !&#34;</span>
 
 <span class="kd">func</span> <span class="nf">doThings</span><span class="p">()</span> <span class="p">{</span>
	<span class="n">myString</span> <span class="p">=</span> <span class="s">&#34;Bye friend&#34;</span>
	<span class="kd">var</span> <span class="nv">something</span> <span class="p">=</span> <span class="n">myString</span>
 <span class="p">}</span>
<span class="p">}</span>

<span class="n">SomeClass</span><span class="p">().</span><span class="n">doThings</span><span class="p">()</span>
</code></pre></div><p>ce qui imprimera</p>
<pre><code>&gt; Setting 'Bye friend'
&gt; Getting 'Bye friend'
</code></pre><p>ce qui est plutôt nul.</p>
<p>Ceci-dit, si on décidait de faire des choses plus intéressantes que des print, on pourrait bien se faciliter la vie !</p>
<h2 id="got-userdefaults-"><a href="#got-userdefaults-" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>Got UserDefaults ?</h2>
<h3 id="stocker-des-propriétés-dans-les-userdefaults"><a href="#stocker-des-propriétés-dans-les-userdefaults" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>Stocker des propriétés dans les UserDefaults</h3>
<p>Voilà un usage fréquent et intéressant.</p>
<div class="highlight"><pre class="chroma"><code class="language-swift" data-lang="swift"><span class="p">@</span><span class="n">propertyWrapper</span>
<span class="kd">public</span> <span class="kd">struct</span> <span class="nc">UserDefaultsBacked</span><span class="p">&lt;</span><span class="n">Value</span><span class="p">&gt;</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">key</span><span class="p">:</span> <span class="nb">String</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">defaultValue</span><span class="p">:</span> <span class="n">Value</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">storage</span><span class="p">:</span> <span class="n">UserDefaults</span>
    
    <span class="kd">public</span> <span class="kd">init</span><span class="p">(</span><span class="n">wrappedValue</span> <span class="n">value</span><span class="p">:</span> <span class="n">Value</span><span class="p">,</span> <span class="kc">_</span> <span class="n">key</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span> <span class="n">storage</span><span class="p">:</span> <span class="n">UserDefaults</span> <span class="p">=</span> <span class="p">.</span><span class="n">standard</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">defaultValue</span> <span class="p">=</span> <span class="n">value</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">key</span> <span class="p">=</span> <span class="n">key</span>
				<span class="kc">self</span><span class="p">.</span><span class="n">storage</span> <span class="p">=</span> <span class="n">storage</span>
    <span class="p">}</span>
    
    <span class="kd">public</span> <span class="kd">var</span> <span class="nv">wrappedValue</span><span class="p">:</span> <span class="n">Value</span> <span class="p">{</span>
        <span class="kr">get</span> <span class="p">{</span> <span class="n">storage</span><span class="p">.</span><span class="n">value</span><span class="p">(</span><span class="n">forKey</span><span class="p">:</span> <span class="n">key</span><span class="p">)</span> <span class="k">as</span><span class="p">?</span> <span class="n">Value</span> <span class="p">??</span> <span class="n">defaultValue</span><span class="p">}</span>
        <span class="kr">set</span> <span class="p">{</span> <span class="n">storage</span><span class="p">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">newValue</span><span class="p">,</span> <span class="n">forKey</span><span class="p">:</span> <span class="n">key</span><span class="p">)</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>Et une implémentation un peu naïve comme celle ci-dessus peut faire l&rsquo;affaire.</p>
<p><strong>Un petit warning</strong> quand même, on n&rsquo;oublie pas que chaque <em>setValue</em> sur une clé de <code>UserDefaults</code> réécrit le dictionnaire complet. On utilisera donc tout ça en connaissance de cause, et n&rsquo;oublions pas qu&rsquo;on peut aussi réduire leur taille en n&rsquo;utilisant pas systématiquement le <code>.standard</code>.</p>
<p>On peut noter la présence de nouveaux arguments du constructeur, la <code>key</code> et le <code>storage</code>. Ils peuvent être fournis via la déclaration de l&rsquo;annotation, ou doivent l&rsquo;être pour ceux qui n&rsquo;ont pas de valeur par défaut comme la key.</p>
<div class="highlight"><pre class="chroma"><code class="language-swift" data-lang="swift"><span class="p">@</span><span class="n">UserDefaultsBacked</span><span class="p">(</span><span class="s">&#34;int-key&#34;</span><span class="p">)</span> <span class="c1">// Smells like Java</span>
<span class="kd">var</span> <span class="nv">someInt</span> <span class="p">=</span> <span class="mi">8</span>

<span class="p">@</span><span class="n">UserDefaultsBacked</span><span class="p">(</span><span class="s">&#34;my-data&#34;</span><span class="p">,</span> <span class="n">storage</span><span class="p">:</span> <span class="n">UserDefaults</span><span class="p">(</span><span class="s">&#34;DBName&#34;</span><span class="p">))</span>
<span class="kd">var</span> <span class="nv">someData</span><span class="p">:</span> <span class="n">Data</span><span class="p">?</span> <span class="p">=</span> <span class="kc">nil</span>

<span class="kd">struct</span> <span class="nc">SomeStruct</span> <span class="p">{</span>
 <span class="kd">var</span> <span class="nv">prop</span> <span class="p">=</span> <span class="s">&#34;Yup&#34;</span>
<span class="p">}</span>

<span class="p">@</span><span class="n">UserDefaultsBacked</span><span class="p">(</span><span class="s">&#34;my-struct&#34;</span><span class="p">)</span>
<span class="kd">var</span> <span class="nv">myStruct</span> <span class="p">=</span> <span class="n">SomeStruct</span><span class="p">()</span> <span class="c1">// Wait... What ?</span>

</code></pre></div><h3 id="stocker-uniquement-les-types-compatibles"><a href="#stocker-uniquement-les-types-compatibles" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>Stocker uniquement les types compatibles</h3>
<p>Ce wrapper fonctionnera très bien avec tous les types supportés par les <code>UserDefaults</code> mais attendez-vous à de bons crashes pour tous les autres cas, comme <code>SomeStruct</code>.</p>
<p>Restreignons-donc déjà l&rsquo;usage aux bonnes valeurs grâce à un <em>flag protocol</em> :</p>
<div class="highlight"><pre class="chroma"><code class="language-swift" data-lang="swift"><span class="kd">public</span> <span class="kd">protocol</span> <span class="nc">UserDefaultsStorable</span> <span class="p">{}</span>

<span class="kd">extension</span> <span class="nc">String</span> <span class="p">:</span> <span class="n">UserDefaultsStorable</span> <span class="p">{}</span>
<span class="kd">extension</span> <span class="nc">Int</span><span class="p">:</span> <span class="n">UserDefaultsStorable</span> <span class="p">{}</span>
<span class="kd">extension</span> <span class="nc">Double</span><span class="p">:</span> <span class="n">UserDefaultsStorable</span> <span class="p">{}</span>
<span class="kd">extension</span> <span class="nc">Float</span><span class="p">:</span> <span class="n">UserDefaultsStorable</span> <span class="p">{}</span>
<span class="kd">extension</span> <span class="nc">Date</span><span class="p">:</span> <span class="n">UserDefaultsStorable</span> <span class="p">{}</span>
<span class="kd">extension</span> <span class="nc">Data</span><span class="p">:</span> <span class="n">UserDefaultsStorable</span> <span class="p">{}</span>
<span class="kd">extension</span> <span class="nc">Array</span><span class="p">:</span> <span class="n">UserDefaultsStorable</span> <span class="k">where</span> <span class="n">Element</span><span class="p">:</span> <span class="n">UserDefaultsStorable</span> <span class="p">{}</span>
<span class="kd">extension</span> <span class="nc">Dictionary</span><span class="p">:</span> <span class="n">UserDefaultsStorable</span> <span class="k">where</span> <span class="n">Key</span> <span class="p">==</span> <span class="nb">String</span><span class="p">,</span> <span class="n">Value</span><span class="p">:</span> <span class="n">UserDefaultsStorable</span> <span class="p">{}</span>

<span class="p">@</span><span class="n">propertyWrapper</span>
<span class="kd">public</span> <span class="kd">struct</span> <span class="nc">UserDefaultsBacked</span><span class="p">&lt;</span><span class="n">Value</span><span class="p">&gt;</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">key</span><span class="p">:</span> <span class="nb">String</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">defaultValue</span><span class="p">:</span> <span class="n">Value</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">storage</span><span class="p">:</span> <span class="n">UserDefaults</span>
    
    <span class="kd">public</span> <span class="kd">init</span><span class="p">(</span><span class="n">wrappedValue</span> <span class="n">value</span><span class="p">:</span> <span class="n">Value</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span> <span class="n">storage</span><span class="p">:</span> <span class="n">UserDefaults</span> <span class="p">=</span> <span class="p">.</span><span class="n">standard</span><span class="p">)</span> <span class="k">where</span> <span class="n">Value</span><span class="p">:</span> <span class="n">UserDefaultsStorable</span> <span class="p">{</span>
        <span class="n">defaultValue</span> <span class="p">=</span> <span class="n">value</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">key</span> <span class="p">=</span> <span class="n">key</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">storage</span> <span class="p">=</span> <span class="n">storage</span>
    <span class="p">}</span>
    
    <span class="kd">public</span> <span class="kd">var</span> <span class="nv">wrappedValue</span><span class="p">:</span> <span class="n">Value</span> <span class="p">{</span>
        <span class="kr">get</span> <span class="p">{</span> <span class="n">storage</span><span class="p">.</span><span class="n">value</span><span class="p">(</span><span class="n">forKey</span><span class="p">:</span> <span class="n">key</span><span class="p">)</span> <span class="k">as</span><span class="p">?</span> <span class="n">Value</span> <span class="p">??</span> <span class="n">defaultValue</span><span class="p">}</span>
        <span class="kr">set</span> <span class="p">{</span> <span class="n">storage</span><span class="p">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">newValue</span><span class="p">,</span> <span class="n">forKey</span><span class="p">:</span> <span class="n">key</span><span class="p">)</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>Ok, on a maintenant un property wrapper sélectif et une belle erreur de compilation dans le cas où le type ne se conforme pas à <code>UserDefaultsStorable</code>.</p>
<div class="highlight"><pre class="chroma"><code class="language-swift" data-lang="swift"><span class="p">@</span><span class="n">UserDefaultsBacked</span><span class="p">(</span><span class="s">&#34;my-struct&#34;</span><span class="p">)</span>
<span class="kd">var</span> <span class="nv">myStruct</span> <span class="p">=</span> <span class="n">SomeStruct</span><span class="p">()</span>
<span class="c1">// Error: Initializer &#39;init(wrappedValue:_:storage)&#39; requires that &#39;SomeStruct&#39; conform to &#39;UserDefaultsStorable&#39;</span>
</code></pre></div><h3 id="stocker-les-codables"><a href="#stocker-les-codables" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>Stocker les Codables</h3>
<p>Bien mais <code>SomeStruct</code> n&rsquo;est pas bien mystérieux, ce serait bien sympa de pouvoir le stocker aussi. En fait, tout codable est a priori stockable puisque <code>Data</code> l&rsquo;est. Seulement pour éviter de se faire la conversion à chaque accès, profitons donc de notre wrapper.</p>
<p>Généralisons : on peut avoir à mapper les données dans un sens et dans l&rsquo;autre pour pouvoir les stocker. L&rsquo;interface de <code>UserDefaults</code> utilise le très générique <code>Any?</code>, on va donc définir les mappers :</p>
<div class="highlight"><pre class="chroma"><code class="language-swift" data-lang="swift"><span class="kd">typealias</span> <span class="n">StoringMapper</span><span class="p">&lt;</span><span class="n">Value</span><span class="p">&gt;</span> <span class="p">=</span> <span class="p">(</span><span class="n">Value</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="nb">Any</span><span class="p">?</span>
<span class="kd">typealias</span> <span class="n">StoreReadingMapper</span><span class="p">&lt;</span><span class="n">Value</span><span class="p">&gt;</span> <span class="p">=</span> <span class="p">(</span><span class="nb">Any</span><span class="p">?)</span> <span class="p">-&gt;</span> <span class="n">Value</span><span class="p">?</span>
</code></pre></div><p>Puis:</p>
<ul>
<li>définir des propriétés de ce type dans notre wrapper.</li>
<li>définir un constructeur privé aveugle qui prend de bonne fois n&rsquo;importe quel type de propriété avec des mappers</li>
<li>définir des constructeurs publics stricts sur le type qui vont fournir des mappers au constructeur privé</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-swift" data-lang="swift"><span class="p">@</span><span class="n">propertyWrapper</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserDefaultsBacked</span><span class="p">&lt;</span><span class="n">Value</span><span class="p">&gt;</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">key</span><span class="p">:</span> <span class="nb">String</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">storage</span><span class="p">:</span> <span class="n">UserDefaults</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">defaultValue</span><span class="p">:</span> <span class="n">Value</span>
    <span class="kd">private</span> <span class="kd">var</span> <span class="nv">storingMapper</span><span class="p">:</span> <span class="p">(</span><span class="n">Value</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="nb">Any</span><span class="p">?</span>
    <span class="kd">private</span> <span class="kd">var</span> <span class="nv">storeReadingMapper</span><span class="p">:</span> <span class="p">(</span><span class="nb">Any</span><span class="p">?)</span> <span class="p">-&gt;</span> <span class="n">Value</span><span class="p">?</span>
    
    <span class="kd">private</span> <span class="kd">init</span><span class="p">(</span><span class="n">wrappedValue</span> <span class="n">value</span><span class="p">:</span> <span class="n">Value</span><span class="p">,</span>
                 <span class="kc">_</span> <span class="n">key</span><span class="p">:</span> <span class="nb">String</span> <span class="p">,</span>
                 <span class="n">storage</span><span class="p">:</span> <span class="n">UserDefaults</span><span class="p">,</span>
                 <span class="n">storingMapper</span><span class="p">:</span> <span class="p">@</span><span class="n">escaping</span> <span class="n">StoringMapper</span><span class="p">&lt;</span><span class="n">Value</span><span class="p">&gt;,</span>
                 <span class="n">storeReadingMapper</span><span class="p">:</span> <span class="p">@</span><span class="n">escaping</span> <span class="n">StoreReadingMapper</span><span class="p">&lt;</span><span class="n">Value</span><span class="p">&gt;)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nv">initValue</span> <span class="p">=</span> <span class="n">value</span>
        <span class="k">if</span> <span class="kd">let</span> <span class="nv">storedValue</span> <span class="p">=</span> <span class="n">storeReadingMapper</span><span class="p">(</span><span class="n">storage</span><span class="p">.</span><span class="n">object</span><span class="p">(</span><span class="n">forKey</span><span class="p">:</span> <span class="n">key</span><span class="p">))</span> <span class="p">{</span>
           <span class="n">initValue</span> <span class="p">=</span> <span class="n">storedValue</span>
        <span class="p">}</span>
        <span class="n">defaultValue</span> <span class="p">=</span> <span class="n">initValue</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">key</span> <span class="p">=</span> <span class="n">key</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">storage</span> <span class="p">=</span> <span class="n">storage</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">storingMapper</span> <span class="p">=</span> <span class="n">storingMapper</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">storeReadingMapper</span> <span class="p">=</span> <span class="n">storeReadingMapper</span>
    <span class="p">}</span>
    
    <span class="kd">public</span> <span class="kr">convenience</span> <span class="kd">init</span><span class="p">(</span><span class="n">wrappedValue</span> <span class="n">value</span><span class="p">:</span> <span class="n">Value</span><span class="p">,</span>
                            <span class="kc">_</span> <span class="n">key</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span>
                            <span class="n">storage</span><span class="p">:</span> <span class="n">UserDefaults</span> <span class="p">=</span> <span class="p">.</span><span class="n">standard</span><span class="p">,</span>
                            <span class="n">sendAfterStore</span><span class="p">:</span> <span class="nb">Bool</span> <span class="p">=</span> <span class="kc">false</span><span class="p">)</span> <span class="k">where</span> <span class="n">Value</span><span class="p">:</span> <span class="n">UserDefaultsStorable</span> <span class="p">{</span>
        <span class="kc">self</span><span class="p">.</span><span class="kd">init</span><span class="p">(</span><span class="n">wrappedValue</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span>
                  <span class="n">key</span><span class="p">,</span> <span class="n">storage</span><span class="p">:</span> <span class="n">storage</span><span class="p">,</span>
                  <span class="n">storingMapper</span><span class="p">:</span> <span class="p">{</span><span class="nv">$0</span><span class="p">},</span>
                  <span class="n">storeReadingMapper</span><span class="p">:</span> <span class="p">{</span> <span class="nv">$0</span> <span class="k">as</span><span class="p">?</span> <span class="n">Value</span><span class="p">})</span>
    <span class="p">}</span>
    
    
    
    <span class="kd">public</span> <span class="kd">var</span> <span class="nv">wrappedValue</span><span class="p">:</span> <span class="n">Value</span> <span class="p">{</span>
        <span class="kr">get</span> <span class="p">{</span> <span class="n">storage</span><span class="p">.</span><span class="n">value</span><span class="p">(</span><span class="n">forKey</span><span class="p">:</span> <span class="n">key</span><span class="p">)</span> <span class="k">as</span><span class="p">?</span> <span class="n">Value</span> <span class="p">??</span> <span class="n">defaultValue</span><span class="p">}</span>
        <span class="kr">set</span> <span class="p">{</span> <span class="n">storage</span><span class="p">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">newValue</span><span class="p">,</span> <span class="n">forKey</span><span class="p">:</span> <span class="n">key</span><span class="p">)</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>Mais pour mes <code>Codable</code>s les mappers ne sont pas si évidents.</p>
<div class="highlight"><pre class="chroma"><code class="language-swift" data-lang="swift"><span class="kd">public</span> <span class="kd">extension</span> <span class="nc">Encodable</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">mapForStorage</span><span class="p">()</span> <span class="p">-&gt;</span> <span class="nb">Any</span><span class="p">?</span> <span class="p">{</span>
        <span class="k">do</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">try</span> <span class="n">JSONEncoder</span><span class="p">().</span><span class="n">encode</span><span class="p">(</span><span class="kc">self</span><span class="p">)</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
            <span class="bp">print</span><span class="p">(</span><span class="s">&#34;Couldn&#39;t encode </span><span class="si">\(</span><span class="kc">self</span><span class="si">)</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">nil</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>Ci-dessus la fonction d&rsquo;encodage, avec absolument pas de check sur le cas où l&rsquo;objet est également stockable nativement, car la discrimination s&rsquo;effectuera en amont. Bon, c&rsquo;est l&rsquo;équivalent de <code>try? JSONEncoder().encode(self)</code> mais avec une trace pour ne pas être complètement dans le brouillard en cas de problème. Evidemment on préfèrera certainement donner de meilleures options de traçage, et certains se sentent mal (à raison) de ne pas <code>throw</code> quoi que ce soit, mais ce n&rsquo;est pas le débat ici. Et puis comme on dit parfois : &ldquo;Quand tout va bien, tout va bien !&rdquo;.</p>
<div class="highlight"><pre class="chroma"><code class="language-swift" data-lang="swift"><span class="c1">/// Simple type opening using a static function to allow JSON decoding with erased types conforming to `Decodable` protocol</span>
<span class="n">fileprivate</span> <span class="kd">extension</span> <span class="nc">Decodable</span> <span class="p">{</span>
    <span class="kd">static</span> <span class="kd">func</span> <span class="nf">openedJSONDecode</span><span class="p">(</span><span class="n">using</span> <span class="n">decoder</span><span class="p">:</span> <span class="n">JSONDecoder</span><span class="p">,</span> <span class="n">from</span> <span class="n">data</span><span class="p">:</span> <span class="n">Data</span><span class="p">)</span> <span class="kr">throws</span> <span class="p">-&gt;</span> <span class="kc">Self</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">try</span> <span class="n">decoder</span><span class="p">.</span><span class="n">decode</span><span class="p">(</span><span class="kc">self</span><span class="p">,</span> <span class="n">from</span><span class="p">:</span> <span class="n">data</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p><em>Joyeusement pompé de <a href="https://stackoverflow.com/questions/54963038/codable-conformance-with-erased-types" target="_blank" rel="noopener">ce post SO</a></em></p>
<p>Tiens je parlais dans mon poste précédent de type erasure, mais saviez vous que l&rsquo;inverse est le <em>type opening</em> ? Eh bien pareil, je me suis couché moins bête. Et pour tous ceux qui ont déjà joué avec un <code>JSONDecoder</code> dans des contextes génériques un peu poussés, la feinte ci-dessus est plutôt cool à retenir : une fonction statique a toujours accès au type concret, ce qui satisfait le compilo.</p>
<div class="highlight"><pre class="chroma"><code class="language-swift" data-lang="swift"><span class="kd">public</span> <span class="kd">extension</span> <span class="nc">Decodable</span> <span class="p">{</span>
    <span class="kd">static</span> <span class="kd">func</span> <span class="nf">mapOutOfStorage</span><span class="p">(</span><span class="kc">_</span> <span class="n">value</span><span class="p">:</span> <span class="nb">Any</span><span class="p">?)</span> <span class="p">-&gt;</span> <span class="kc">Self</span><span class="p">?</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="kd">let</span> <span class="nv">data</span> <span class="p">=</span> <span class="n">value</span> <span class="k">as</span><span class="p">?</span> <span class="n">Data</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="kc">nil</span> <span class="p">}</span>
        <span class="k">do</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">try</span> <span class="kc">Self</span><span class="p">.</span><span class="n">openedJSONDecode</span><span class="p">(</span><span class="n">using</span><span class="p">:</span> <span class="n">JSONDecoder</span><span class="p">(),</span> <span class="n">from</span><span class="p">:</span> <span class="n">data</span><span class="p">)</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
            <span class="bp">print</span><span class="p">(</span><span class="s">&#34;Couldn&#39;t decode </span><span class="si">\(</span><span class="nb">String</span><span class="si">(</span><span class="n">describing</span><span class="p">:</span> <span class="n">value</span><span class="si">))</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span>
            <span class="c1">// Very opinionated choice to ignore thrown errors</span>
            <span class="k">return</span> <span class="kc">nil</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>Et voilà, sur tout type se conformant à <code>Decodable</code> on a désormais cette fonction <code>mapOutOfStorage</code>.</p>
<p>Je rappelle que <code>typealias Codable = Decodable &amp; Encodable</code>, donc pour tout type <code>Codable</code> on a nos deux mappers \o/</p>
<p>Rajoutons donc ce petit constructeur à notre property wrapper <code>UserDefaultsBacked</code> :</p>
<div class="highlight"><pre class="chroma"><code class="language-swift" data-lang="swift">    <span class="kr">convenience</span> <span class="kd">init</span><span class="p">(</span><span class="n">wrappedValue</span> <span class="n">value</span><span class="p">:</span> <span class="n">Value</span><span class="p">,</span>
                            <span class="kc">_</span> <span class="n">key</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span>
                            <span class="n">storage</span><span class="p">:</span> <span class="n">UserDefaults</span> <span class="p">=</span> <span class="p">.</span><span class="n">standard</span><span class="p">)</span> <span class="k">where</span> <span class="n">Value</span> <span class="p">:</span> <span class="n">Codable</span> <span class="p">{</span>
        <span class="kc">self</span><span class="p">.</span><span class="kd">init</span><span class="p">(</span><span class="n">wrappedValue</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span>
                  <span class="n">key</span><span class="p">,</span>
                  <span class="n">storage</span><span class="p">:</span> <span class="n">storage</span><span class="p">,</span>
                  <span class="n">storingMapper</span><span class="p">:</span> <span class="n">Value</span><span class="p">.</span><span class="n">mapForStorage</span><span class="p">,</span>
                  <span class="n">storeReadingMapper</span><span class="p">:</span> <span class="n">Value</span><span class="p">.</span><span class="n">mapOutOfStorage</span><span class="p">)</span>
    <span class="p">}</span>
</code></pre></div><p>Nice, et maintenant qu&rsquo;est ce qui se passe si je déclare quelque chose comme :</p>
<pre><code>@UserDefaultsBacked(&quot;myKey&quot;)
var myInt = 0
// Error: Ambiguous use of 'init(wrappedValue:_:storage:sendAfterStore:)'
</code></pre><p>Eh bien les <code>Int</code> étant <code>Codable</code> mais aussi <code>UserDefaultsStorable</code>, le compilateur ne saura quel constructeur choisir. Deux solutions : enlever l&rsquo;ambiguité en changeant la signature d&rsquo;un des constructeurs (ce qui est un peu minable, même simplement d&rsquo;y avoir pensé), ou donner un constructeur qui match encore mieux, avec <code>where Value : Codable &amp; UserDefaultsStorable</code>. Encore un bon trick, vous êtes bienvenus.</p>
<h3 id="checkpoint"><a href="#checkpoint" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>Checkpoint</h3>
<p>Voici un petit bilan :</p>
<div class="highlight"><pre class="chroma"><code class="language-swift" data-lang="swift"><span class="c1">/// Any type implementing this protocol can be stored natively in UserDefaults</span>
<span class="kd">public</span> <span class="kd">protocol</span> <span class="nc">UserDefaultsStorable</span> <span class="p">{}</span>

<span class="cm">/**
</span><span class="cm"> Declare proper flag protocol conformance for all types natively compatible with UserDefaults storage
</span><span class="cm">*/</span>
<span class="kd">extension</span> <span class="nc">String</span> <span class="p">:</span> <span class="n">UserDefaultsStorable</span> <span class="p">{}</span>
<span class="kd">extension</span> <span class="nc">Int</span><span class="p">:</span> <span class="n">UserDefaultsStorable</span> <span class="p">{}</span>
<span class="kd">extension</span> <span class="nc">Double</span><span class="p">:</span> <span class="n">UserDefaultsStorable</span> <span class="p">{}</span>
<span class="kd">extension</span> <span class="nc">Float</span><span class="p">:</span> <span class="n">UserDefaultsStorable</span> <span class="p">{}</span>
<span class="kd">extension</span> <span class="nc">Date</span><span class="p">:</span> <span class="n">UserDefaultsStorable</span> <span class="p">{}</span>
<span class="kd">extension</span> <span class="nc">Data</span><span class="p">:</span> <span class="n">UserDefaultsStorable</span> <span class="p">{}</span>
<span class="kd">extension</span> <span class="nc">Array</span><span class="p">:</span> <span class="n">UserDefaultsStorable</span> <span class="k">where</span> <span class="n">Element</span><span class="p">:</span> <span class="n">UserDefaultsStorable</span> <span class="p">{}</span>
<span class="kd">extension</span> <span class="nc">Dictionary</span><span class="p">:</span> <span class="n">UserDefaultsStorable</span> <span class="k">where</span> <span class="n">Key</span> <span class="p">==</span> <span class="nb">String</span><span class="p">,</span> <span class="n">Value</span><span class="p">:</span> <span class="n">UserDefaultsStorable</span> <span class="p">{}</span>

<span class="c1">/// `Encodable` mapping for storage</span>
<span class="kd">public</span> <span class="kd">extension</span> <span class="nc">Encodable</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">mapForStorage</span><span class="p">()</span> <span class="p">-&gt;</span> <span class="nb">Any</span><span class="p">?</span> <span class="p">{</span>
        <span class="k">do</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">try</span> <span class="n">JSONEncoder</span><span class="p">().</span><span class="n">encode</span><span class="p">(</span><span class="kc">self</span><span class="p">)</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
            <span class="bp">print</span><span class="p">(</span><span class="s">&#34;Couldn&#39;t encode </span><span class="si">\(</span><span class="kc">self</span><span class="si">)</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">nil</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">/// Simple type opening using a static function to allow JSON decoding with erased types conforming to `Decodable` protocol</span>
<span class="n">fileprivate</span> <span class="kd">extension</span> <span class="nc">Decodable</span> <span class="p">{</span>
    <span class="c1">// Useful trick from https://stackoverflow.com/questions/54963038/codable-conformance-with-erased-types</span>
    <span class="kd">static</span> <span class="kd">func</span> <span class="nf">openedJSONDecode</span><span class="p">(</span><span class="n">using</span> <span class="n">decoder</span><span class="p">:</span> <span class="n">JSONDecoder</span><span class="p">,</span> <span class="n">from</span> <span class="n">data</span><span class="p">:</span> <span class="n">Data</span><span class="p">)</span> <span class="kr">throws</span> <span class="p">-&gt;</span> <span class="kc">Self</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">try</span> <span class="n">decoder</span><span class="p">.</span><span class="n">decode</span><span class="p">(</span><span class="kc">self</span><span class="p">,</span> <span class="n">from</span><span class="p">:</span> <span class="n">data</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">/// `Decodable` mapping for reading from storage</span>
<span class="kd">public</span> <span class="kd">extension</span> <span class="nc">Decodable</span> <span class="p">{</span>
    <span class="kd">static</span> <span class="kd">func</span> <span class="nf">mapOutOfStorage</span><span class="p">(</span><span class="kc">_</span> <span class="n">value</span><span class="p">:</span> <span class="nb">Any</span><span class="p">?)</span> <span class="p">-&gt;</span> <span class="kc">Self</span><span class="p">?</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="kd">let</span> <span class="nv">data</span> <span class="p">=</span> <span class="n">value</span> <span class="k">as</span><span class="p">?</span> <span class="n">Data</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="kc">nil</span> <span class="p">}</span>
        <span class="k">do</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">try</span> <span class="kc">Self</span><span class="p">.</span><span class="n">openedJSONDecode</span><span class="p">(</span><span class="n">using</span><span class="p">:</span> <span class="n">JSONDecoder</span><span class="p">(),</span> <span class="n">from</span><span class="p">:</span> <span class="n">data</span><span class="p">)</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
            <span class="bp">print</span><span class="p">(</span><span class="s">&#34;Couldn&#39;t decode </span><span class="si">\(</span><span class="nb">String</span><span class="si">(</span><span class="n">describing</span><span class="p">:</span> <span class="n">value</span><span class="si">))</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span>
            <span class="c1">// Very opinionated choice to almost ignore thrown errors</span>
            <span class="k">return</span> <span class="kc">nil</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="p">@</span><span class="n">propertyWrapper</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserDefaultsBacked</span><span class="p">&lt;</span><span class="n">Value</span><span class="p">&gt;</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">key</span><span class="p">:</span> <span class="nb">String</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">storage</span><span class="p">:</span> <span class="n">UserDefaults</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">defaultValue</span><span class="p">:</span> <span class="n">Value</span>
    <span class="kd">private</span> <span class="kd">var</span> <span class="nv">storingMapper</span><span class="p">:</span> <span class="p">(</span><span class="n">Value</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="nb">Any</span><span class="p">?</span>
    <span class="kd">private</span> <span class="kd">var</span> <span class="nv">storeReadingMapper</span><span class="p">:</span> <span class="p">(</span><span class="nb">Any</span><span class="p">?)</span> <span class="p">-&gt;</span> <span class="n">Value</span><span class="p">?</span>
    
    <span class="kd">private</span> <span class="kd">init</span><span class="p">(</span><span class="n">wrappedValue</span> <span class="n">value</span><span class="p">:</span> <span class="n">Value</span><span class="p">,</span>
                 <span class="kc">_</span> <span class="n">key</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span>
                 <span class="n">storage</span><span class="p">:</span> <span class="n">UserDefaults</span><span class="p">,</span>
                 <span class="n">storingMapper</span><span class="p">:</span> <span class="p">@</span><span class="n">escaping</span> <span class="n">StoringMapper</span><span class="p">&lt;</span><span class="n">Value</span><span class="p">&gt;,</span>
                 <span class="n">storeReadingMapper</span><span class="p">:</span> <span class="p">@</span><span class="n">escaping</span> <span class="n">StoreReadingMapper</span><span class="p">&lt;</span><span class="n">Value</span><span class="p">&gt;)</span> <span class="p">{</span>
        <span class="n">defaultValue</span> <span class="p">=</span> <span class="n">value</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">key</span> <span class="p">=</span> <span class="n">key</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">storage</span> <span class="p">=</span> <span class="n">storage</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">storingMapper</span> <span class="p">=</span> <span class="n">storingMapper</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">storeReadingMapper</span> <span class="p">=</span> <span class="n">storeReadingMapper</span>
    <span class="p">}</span>
    
    <span class="kd">public</span> <span class="kr">convenience</span> <span class="kd">init</span><span class="p">(</span><span class="n">wrappedValue</span> <span class="n">value</span><span class="p">:</span> <span class="n">Value</span><span class="p">,</span>
                            <span class="kc">_</span> <span class="n">key</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span>
                            <span class="n">storage</span><span class="p">:</span> <span class="n">UserDefaults</span> <span class="p">=</span> <span class="p">.</span><span class="n">standard</span><span class="p">)</span> <span class="k">where</span> <span class="n">Value</span><span class="p">:</span> <span class="n">UserDefaultsStorable</span> <span class="p">{</span>
        <span class="kc">self</span><span class="p">.</span><span class="kd">init</span><span class="p">(</span><span class="n">wrappedValue</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span>
                  <span class="n">key</span><span class="p">,</span>
                  <span class="n">storage</span><span class="p">:</span> <span class="n">storage</span><span class="p">,</span>
                  <span class="n">storingMapper</span><span class="p">:</span> <span class="p">{</span><span class="nv">$0</span><span class="p">},</span>
                  <span class="n">storeReadingMapper</span><span class="p">:</span> <span class="p">{</span> <span class="nv">$0</span> <span class="k">as</span><span class="p">?</span> <span class="n">Value</span><span class="p">})</span>
    <span class="p">}</span>
    
    <span class="kd">public</span> <span class="kr">convenience</span> <span class="kd">init</span><span class="p">(</span><span class="n">wrappedValue</span> <span class="n">value</span><span class="p">:</span> <span class="n">Value</span><span class="p">,</span>
                            <span class="kc">_</span> <span class="n">key</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span>
                            <span class="n">storage</span><span class="p">:</span> <span class="n">UserDefaults</span> <span class="p">=</span> <span class="p">.</span><span class="n">standard</span><span class="p">,</span>
                            <span class="n">sendAfterStore</span><span class="p">:</span> <span class="nb">Bool</span> <span class="p">=</span> <span class="kc">false</span><span class="p">)</span> <span class="k">where</span> <span class="n">Value</span> <span class="p">:</span> <span class="n">Codable</span> <span class="p">{</span>
        <span class="kc">self</span><span class="p">.</span><span class="kd">init</span><span class="p">(</span><span class="n">wrappedValue</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span>
                  <span class="n">key</span><span class="p">,</span>
                  <span class="n">storage</span><span class="p">:</span> <span class="n">storage</span><span class="p">,</span>
                  <span class="n">storingMapper</span><span class="p">:</span> <span class="n">Value</span><span class="p">.</span><span class="n">mapForStorage</span><span class="p">,</span>
                  <span class="n">storeReadingMapper</span><span class="p">:</span> <span class="n">Value</span><span class="p">.</span><span class="n">mapOutOfStorage</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="kd">public</span> <span class="kr">convenience</span> <span class="kd">init</span><span class="p">(</span><span class="n">wrappedValue</span> <span class="n">value</span><span class="p">:</span> <span class="n">Value</span><span class="p">,</span>
                            <span class="kc">_</span> <span class="n">key</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span>
                            <span class="n">storage</span><span class="p">:</span> <span class="n">UserDefaults</span> <span class="p">=</span> <span class="p">.</span><span class="n">standard</span><span class="p">,</span>
                            <span class="n">sendAfterStore</span><span class="p">:</span> <span class="nb">Bool</span> <span class="p">=</span> <span class="kc">false</span><span class="p">)</span> <span class="k">where</span> <span class="n">Value</span> <span class="p">:</span> <span class="n">Codable</span> <span class="o">&amp;</span> <span class="n">UserDefaultsStorable</span> <span class="p">{</span>
        <span class="kc">self</span><span class="p">.</span><span class="kd">init</span><span class="p">(</span><span class="n">wrappedValue</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span>
                  <span class="n">key</span><span class="p">,</span>
                  <span class="n">storage</span><span class="p">:</span> <span class="n">storage</span><span class="p">,</span>
                  <span class="n">storingMapper</span><span class="p">:</span> <span class="p">{</span><span class="nv">$0</span><span class="p">},</span>
                  <span class="n">storeReadingMapper</span><span class="p">:</span> <span class="p">{</span><span class="nv">$0</span> <span class="k">as</span><span class="p">?</span> <span class="n">Value</span><span class="p">})</span>
    <span class="p">}</span>
    
    <span class="kd">public</span> <span class="kd">var</span> <span class="nv">wrappedValue</span><span class="p">:</span> <span class="n">Value</span> <span class="p">{</span>
        <span class="kr">get</span> <span class="p">{</span> <span class="n">storage</span><span class="p">.</span><span class="n">value</span><span class="p">(</span><span class="n">forKey</span><span class="p">:</span> <span class="n">key</span><span class="p">)</span> <span class="k">as</span><span class="p">?</span> <span class="n">Value</span> <span class="p">??</span> <span class="n">defaultValue</span><span class="p">}</span>
        <span class="kr">set</span> <span class="p">{</span> <span class="n">storage</span><span class="p">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">newValue</span><span class="p">,</span> <span class="n">forKey</span><span class="p">:</span> <span class="n">key</span><span class="p">)</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p><em>Fun fact</em> : j&rsquo;ai retrouvé le même flag protocol sur un post (je l&rsquo;ai plus sous la main là), puis vu des implémentations proches pour les <code>Codable</code>, mais tout ça bien sûr après avoir réinventé la roue. Et même si on dit souvent ça péjorativement, dans une démarche d&rsquo;apprentissage ça a tout son sens de regarder les solutions seulement ensuite. Et en plus c&rsquo;était vachement moins bien fait, <a href="https://swiftsenpai.com/swift/create-the-perfect-userdefaults-wrapper-using-property-wrapper/" target="_blank" rel="noopener">genre là</a> pas de type checking, aucune cohabitation entre les <code>Codable</code> et les types natifs&hellip; Nan mais jvous jure&hellip;</p>
<p>Et puis de toute façon je voulais aussi m&rsquo;occuper de faire &hellip;</p>
<h2 id="un-publisher-un-peu-custom"><a href="#un-publisher-un-peu-custom" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>Un publisher un peu custom</h2>
<p>Lorsqu&rsquo;on utilise SwiftUI et Combine simplement, on va naturellement devoir taper des expression comme <code>$myState</code> ou <code>$myObject.prop</code>. Une fois passée mon aversion forte pour le PHP, j&rsquo;ai creusé rapidement pour constater que ce n&rsquo;était qu&rsquo;une syntaxe un peu flippante pour accéder à la valeur projetée d&rsquo;une wrapped property.</p>
<h3 id="projected-value-"><a href="#projected-value-" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>Projected value ?</h3>
<p>En bref, n&rsquo;importe quel property wrapper peut déclarer une <code>var projectedValue: SomeType {...}</code> dont le type n&rsquo;est pas nécessairement le même que celui de sa <code>wrappedValue</code>. Et cette <code>projectedValue</code> est accessible grâce au dollar américain (comme tellement de choses).</p>
<div class="highlight"><pre class="chroma"><code class="language-swift" data-lang="swift"><span class="p">@</span><span class="n">propertyWrapper</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Print</span><span class="p">&lt;</span><span class="n">Value</span><span class="p">&gt;</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="kd">var</span> <span class="nv">val</span><span class="p">:</span> <span class="n">Value</span>
    
    <span class="kd">public</span> <span class="kd">init</span><span class="p">(</span><span class="n">wrappedValue</span> <span class="n">value</span><span class="p">:</span> <span class="n">Value</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">val</span> <span class="p">=</span> <span class="n">value</span>
    <span class="p">}</span>
    
    <span class="kd">public</span> <span class="kd">var</span> <span class="nv">wrappedValue</span><span class="p">:</span> <span class="n">Value</span> <span class="p">{</span>
        <span class="kr">set</span> <span class="p">{</span>
            <span class="bp">print</span><span class="p">(</span><span class="s">&#34;Setting &#39;</span><span class="si">\(</span><span class="n">val</span><span class="si">)</span><span class="s">&#39;&#34;</span><span class="p">)</span>
            <span class="n">val</span> <span class="p">=</span> <span class="n">newValue</span>
        <span class="p">}</span>
        <span class="kr">get</span> <span class="p">{</span> 
            <span class="bp">print</span><span class="p">(</span><span class="s">&#34;Returning &#39;</span><span class="si">\(</span><span class="n">val</span><span class="si">)</span><span class="s">&#39;&#34;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">val</span> 
        <span class="p">}</span>
    <span class="p">}</span>
		
    <span class="kd">public</span> <span class="kd">var</span> <span class="nv">projectedValue</span><span class="p">:</span> <span class="nb">Int</span> <span class="p">{</span>
        <span class="bp">print</span><span class="p">(</span><span class="s">&#34;42&#34;</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">8</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="p">@</span><span class="n">Print</span>
<span class="kd">var</span> <span class="nv">myString</span><span class="p">:</span> <span class="nb">String</span> <span class="p">=</span> <span class="s">&#34;5&#34;</span>

<span class="n">myString</span> <span class="p">=</span> <span class="s">&#34;40&#34;</span>
<span class="bp">print</span><span class="p">(</span><span class="s">&#34;Coucou </span><span class="si">\(</span><span class="err">$</span><span class="n">myString</span><span class="si">)</span><span class="s">&#34;</span><span class="p">)</span>
</code></pre></div><p>printera donc</p>
<pre><code>&gt; Setting '40'
&gt; 42
&gt; Coucou 8
</code></pre><p>Aaah, je pense que j&rsquo;ai fait le pire exemple qui soit, &ldquo;service !&rdquo; comme on dit dans l&rsquo;est.</p>
<p>Bref, ce <code>$</code> n&rsquo;a en théorie pas forcément grand chose à voir avec Combine excepté qu&rsquo;on l&rsquo;y utilise en permanence.</p>
<h3 id="quelques-notions-de-combine"><a href="#quelques-notions-de-combine" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>Quelques notions de Combine</h3>
<p>Typiquement, le property wrapper <code>Published</code> a pour type projeté <strong>la struct</strong> <code>Published&lt;Value&gt;.Publisher</code> (<a href="https://developer.apple.com/documentation/combine/published/publisher" target="_blank" rel="noopener">doc</a>) qui respecte notamment le <strong>protocole</strong> <code>Publisher</code> (et bien plus, <a href="https://developer.apple.com/documentation/combine/publisher" target="_blank" rel="noopener">doc</a>), et peut donc envoyer des <code>Value</code> à des <code>Subscriber</code>.</p>
<p>Donc quand j&rsquo;accède à un <code>@Published var myString: String</code> via <code>$myString</code> j&rsquo;obtiens en gros une propriété dont je peux écouter les valeurs successives.</p>
<p>Et quand je fais du SwiftUI ainsi : <code>.sheet(isPresented: $vm.router.showSheet, ...)</code>, je passe donc un <code>Publisher</code> à la fonction <code>sheet</code> qui se fera un plaisir d&rsquo;écouter si on doit où non présenter cette <code>sheet</code>.</p>
<p><strong>Rappel :</strong> lorsqu&rsquo;on utilise <code>sink</code> pour écouter les valeurs d&rsquo;une var <code>@Published</code> via son <code>Publisher</code>, on reçoit la nouvelle valeur alors que la <code>wrappedValue</code> est encore l&rsquo;ancienne valeur. Et je voudrais contourner ça dans certains cas (voir <a href="/posts/swiftui_combine1">mon post précédent</a>).</p>
<p>Maintenant, ce qui m&rsquo;intéresserait ce serait d&rsquo;avoir ça, un <code>Publisher</code> que je pourrais contrôler finement pour lui envoyer des valeurs.
Eh bien Combine nous fournit gracieusement le protocole <code>Subject</code> qui hérite de <code>Publisher</code> et qui présente de surcroit une fonction <code>send(_:)</code> permettant d&rsquo;envoyer des valeurs à publier. Ses implémentations sont :</p>
<ul>
<li><code>CurrentValueSubject</code> qui détient une valeur courante</li>
<li><code>PassthroughSubject</code> qui au contraire ne retient rien</li>
</ul>
<p>On devrait s&rsquo;en sortir avec ça !</p>
<h3 id="didset-publisher-property-wrapper"><a href="#didset-publisher-property-wrapper" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>DidSet Publisher property wrapper</h3>
<p>Pour reproduire le comportement de <code>@Published</code> on pourrait écrire comme ça comme ça.</p>
<div class="highlight"><pre class="chroma"><code class="language-swift" data-lang="swift"><span class="p">@</span><span class="n">propertyWrapper</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">BasicPublished</span><span class="p">&lt;</span><span class="n">Value</span><span class="p">&gt;</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">subject</span><span class="p">:</span> <span class="n">CurrentValueSubject</span><span class="p">&lt;</span><span class="n">Value</span><span class="p">,</span> <span class="n">Never</span><span class="p">&gt;</span>
    
    <span class="kd">public</span> <span class="kd">init</span><span class="p">(</span><span class="n">wrappedValue</span> <span class="n">value</span><span class="p">:</span> <span class="n">Value</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">subject</span> <span class="p">=</span> <span class="n">CurrentValueSubject</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">wrappedValue</span> <span class="p">=</span> <span class="n">value</span>
    <span class="p">}</span>
    
    <span class="kd">public</span> <span class="kd">var</span> <span class="nv">wrappedValue</span><span class="p">:</span> <span class="n">Value</span> <span class="p">{</span>
        <span class="kr">set</span> <span class="p">{</span>
            <span class="n">subject</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">newValue</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="kr">get</span> <span class="p">{</span> <span class="n">subject</span><span class="p">.</span><span class="n">value</span> <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="kd">public</span> <span class="kd">var</span> <span class="nv">projectedValue</span><span class="p">:</span> <span class="n">CurrentValueSubject</span><span class="p">&lt;</span><span class="n">Value</span><span class="p">,</span> <span class="n">Never</span><span class="p">&gt;</span> <span class="p">{</span>
        <span class="kr">get</span> <span class="p">{</span> <span class="n">subject</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>Le problème étant que lorsque le <code>send</code> va provoquer l&rsquo;exécution de toutes les closures des subscribers, <code>subject.value</code> aura toujours l&rsquo;ancienne valeur.</p>
<p>Assez simple <strong>du coup</strong> d&rsquo;y remédier :</p>
<div class="highlight"><pre class="chroma"><code class="language-swift" data-lang="swift"><span class="p">@</span><span class="n">propertyWrapper</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DidSetPublished</span><span class="p">&lt;</span><span class="n">Value</span><span class="p">&gt;</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="kd">var</span> <span class="nv">val</span><span class="p">:</span> <span class="n">Value</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">subject</span><span class="p">:</span> <span class="n">CurrentValueSubject</span><span class="p">&lt;</span><span class="n">Value</span><span class="p">,</span> <span class="n">Never</span><span class="p">&gt;</span>
    
    <span class="kd">public</span> <span class="kd">init</span><span class="p">(</span><span class="n">wrappedValue</span> <span class="n">value</span><span class="p">:</span> <span class="n">Value</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">val</span> <span class="p">=</span> <span class="n">value</span>
        <span class="n">subject</span> <span class="p">=</span> <span class="n">CurrentValueSubject</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">wrappedValue</span> <span class="p">=</span> <span class="n">value</span>
    <span class="p">}</span>
    
    <span class="kd">public</span> <span class="kd">var</span> <span class="nv">wrappedValue</span><span class="p">:</span> <span class="n">Value</span> <span class="p">{</span>
        <span class="kr">set</span> <span class="p">{</span>
            <span class="n">val</span> <span class="p">=</span> <span class="n">newValue</span>
            <span class="n">subject</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="kr">get</span> <span class="p">{</span> <span class="n">subject</span><span class="p">.</span><span class="n">value</span> <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="kd">public</span> <span class="kd">var</span> <span class="nv">projectedValue</span><span class="p">:</span> <span class="n">CurrentValueSubject</span><span class="p">&lt;</span><span class="n">Value</span><span class="p">,</span> <span class="n">Never</span><span class="p">&gt;</span> <span class="p">{</span>
        <span class="kr">get</span> <span class="p">{</span> <span class="n">subject</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>(je crois que cette implémentation <a href="https://stackoverflow.com/questions/58403338/is-there-an-alternative-to-combines-published-that-signals-a-value-change-afte" target="_blank" rel="noopener">vient de là</a>, et je crois aussi qu&rsquo;il serait plus pertinent d&rsquo;utiliser <code>PassthroughSubject</code> <em>a priori</em>)</p>
<h2 id="tout-ensemble"><a href="#tout-ensemble" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>Tout ensemble</h2>
<p>Vous le saviez, mon but ultime était ~la conquête de la Suède en lama~ de combiner tout ça. Pas juste pour le fun, mais parce que dans mon archi, à un moment, j&rsquo;avais besoin d&rsquo;une propriété <code>Codable</code> (un enum) stockée dans les <code>UserDefaults</code> et qui ne publierait son changement de valeur qu&rsquo;après l&rsquo;avoir affecté à sa <code>wrappedValue</code>.</p>
<p>Et puis d&rsquo;autres besoins avec des variations : pas de stockage mais publication après affectation, stockage natif mais publication avant affectation&hellip;</p>
<p>J&rsquo;aurais bien pu contourner tout ça, ou encore essayer de faire fonctionner des <a href="https://noahgilmore.com/blog/nesting-property-wrappers/" target="_blank" rel="noopener">wrappers imbriqués</a>, mais je voulais me frotter à cette implémentation spécifique.</p>
<p>Et voilà, je vous colle juste l&rsquo;ensemble là dessous, chaque détail étant expliqué dans les parties précédente (enfin faut savoir quelques trucs en amont quand même, oui).</p>
<p>N&rsquo;oubliez pas que la perf n&rsquo;est <strong>pas</strong> l&rsquo;objectif de ce wrapper (du tout).</p>
<p>Je vous suggère d&rsquo;ailleurs de jeter un oeil à l&rsquo;implémentation de <code>Published</code> <a href="https://github.com/OpenCombine/OpenCombine/blob/7286336b28585a594bb4769a680f6f03e375b6ba/Sources/OpenCombine/Published.swift" target="_blank" rel="noopener">chez OpenCombine</a>, qui est particulièrement élégante (ya un enum &lt;3).</p>
<div class="highlight"><pre class="chroma"><code class="language-swift" data-lang="swift"><span class="c1">//</span>
<span class="c1">//  SmartPublished.swift</span>
<span class="c1">//  attestation</span>
<span class="c1">//</span>
<span class="c1">//  Created by Pierre Mardon on 01/01/1970. Trust me.</span>
<span class="c1">//</span>
<span class="kd">import</span> <span class="nc">Foundation</span>
<span class="kd">import</span> <span class="nc">Combine</span>

<span class="c1">/// We need functions to map values before storing them to user defaults</span>
<span class="n">fileprivate</span> <span class="kd">typealias</span> <span class="n">StoringMapper</span><span class="p">&lt;</span><span class="n">Value</span><span class="p">&gt;</span> <span class="p">=</span> <span class="p">(</span><span class="n">Value</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="nb">Any</span><span class="p">?</span>
<span class="c1">/// We need functions to map values read from user defaults storage to an expected type</span>
<span class="n">fileprivate</span> <span class="kd">typealias</span> <span class="n">StoreReadingMapper</span><span class="p">&lt;</span><span class="n">Value</span><span class="p">&gt;</span> <span class="p">=</span> <span class="p">(</span><span class="nb">Any</span><span class="p">?)</span> <span class="p">-&gt;</span> <span class="n">Value</span><span class="p">?</span>

<span class="c1">/// Any type implementing this protocol can be stored natively in UserDefaults</span>
<span class="kd">public</span> <span class="kd">protocol</span> <span class="nc">UserDefaultsStorable</span> <span class="p">{}</span>

<span class="cm">/**
</span><span class="cm"> Declare proper flag protocol conformance for all types natively compatible with UserDefaults storage
</span><span class="cm"> */</span>

<span class="kd">extension</span> <span class="nc">String</span> <span class="p">:</span> <span class="n">UserDefaultsStorable</span> <span class="p">{}</span>
<span class="kd">extension</span> <span class="nc">Int</span><span class="p">:</span> <span class="n">UserDefaultsStorable</span> <span class="p">{}</span>
<span class="kd">extension</span> <span class="nc">Double</span><span class="p">:</span> <span class="n">UserDefaultsStorable</span> <span class="p">{}</span>
<span class="kd">extension</span> <span class="nc">Float</span><span class="p">:</span> <span class="n">UserDefaultsStorable</span> <span class="p">{}</span>
<span class="kd">extension</span> <span class="nc">Date</span><span class="p">:</span> <span class="n">UserDefaultsStorable</span> <span class="p">{}</span>
<span class="kd">extension</span> <span class="nc">Data</span><span class="p">:</span> <span class="n">UserDefaultsStorable</span> <span class="p">{}</span>
<span class="kd">extension</span> <span class="nc">Array</span><span class="p">:</span> <span class="n">UserDefaultsStorable</span> <span class="k">where</span> <span class="n">Element</span><span class="p">:</span> <span class="n">UserDefaultsStorable</span> <span class="p">{}</span>
<span class="kd">extension</span> <span class="nc">Dictionary</span><span class="p">:</span> <span class="n">UserDefaultsStorable</span> <span class="k">where</span> <span class="n">Key</span> <span class="p">==</span> <span class="nb">String</span><span class="p">,</span> <span class="n">Value</span><span class="p">:</span> <span class="n">UserDefaultsStorable</span> <span class="p">{}</span>

<span class="c1">/// `Encodable` mapping for storage</span>
<span class="kd">public</span> <span class="kd">extension</span> <span class="nc">Encodable</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">mapForStorage</span><span class="p">()</span> <span class="p">-&gt;</span> <span class="nb">Any</span><span class="p">?</span> <span class="p">{</span>
        <span class="k">do</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">try</span> <span class="n">JSONEncoder</span><span class="p">().</span><span class="n">encode</span><span class="p">(</span><span class="kc">self</span><span class="p">)</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
            <span class="bp">print</span><span class="p">(</span><span class="s">&#34;Couldn&#39;t encode </span><span class="si">\(</span><span class="kc">self</span><span class="si">)</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">nil</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">/// Simple type opening using a static function to allow JSON decoding with erased types conforming to `Decodable` protocol</span>
<span class="n">fileprivate</span> <span class="kd">extension</span> <span class="nc">Decodable</span> <span class="p">{</span>
    <span class="c1">// Useful trick from https://stackoverflow.com/questions/54963038/codable-conformance-with-erased-types</span>
    <span class="kd">static</span> <span class="kd">func</span> <span class="nf">openedJSONDecode</span><span class="p">(</span><span class="n">using</span> <span class="n">decoder</span><span class="p">:</span> <span class="n">JSONDecoder</span><span class="p">,</span> <span class="n">from</span> <span class="n">data</span><span class="p">:</span> <span class="n">Data</span><span class="p">)</span> <span class="kr">throws</span> <span class="p">-&gt;</span> <span class="kc">Self</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">try</span> <span class="n">decoder</span><span class="p">.</span><span class="n">decode</span><span class="p">(</span><span class="kc">self</span><span class="p">,</span> <span class="n">from</span><span class="p">:</span> <span class="n">data</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">/// `Decodable` mapping for reading from storage</span>
<span class="kd">public</span> <span class="kd">extension</span> <span class="nc">Decodable</span> <span class="p">{</span>
    <span class="kd">static</span> <span class="kd">func</span> <span class="nf">mapOutOfStorage</span><span class="p">(</span><span class="kc">_</span> <span class="n">value</span><span class="p">:</span> <span class="nb">Any</span><span class="p">?)</span> <span class="p">-&gt;</span> <span class="kc">Self</span><span class="p">?</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="kd">let</span> <span class="nv">data</span> <span class="p">=</span> <span class="n">value</span> <span class="k">as</span><span class="p">?</span> <span class="n">Data</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="kc">nil</span> <span class="p">}</span>
        <span class="k">do</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">try</span> <span class="kc">Self</span><span class="p">.</span><span class="n">openedJSONDecode</span><span class="p">(</span><span class="n">using</span><span class="p">:</span> <span class="n">JSONDecoder</span><span class="p">(),</span> <span class="n">from</span><span class="p">:</span> <span class="n">data</span><span class="p">)</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
            <span class="bp">print</span><span class="p">(</span><span class="s">&#34;Couldn&#39;t decode </span><span class="si">\(</span><span class="nb">String</span><span class="si">(</span><span class="n">describing</span><span class="p">:</span> <span class="n">value</span><span class="si">))</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span>
            <span class="c1">// Very opinionated choice to almost ignore thrown errors</span>
            <span class="k">return</span> <span class="kc">nil</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**
</span><span class="cm"> Property wrapper that provides some common use cases options.
</span><span class="cm"> 
</span><span class="cm"> Do NOT use for heavy performance demanding components.
</span><span class="cm"> 
</span><span class="cm"> - `UserDefaults` storage is activated when a `key` is provided for all natively handled types and `Codable` ones
</span><span class="cm"> - option `sendAfterStore` makes the subject send the value only after it has effectively been affected to the property itself: WARNING this is not recommended for UI bindings. Disabled by default.
</span><span class="cm"> 
</span><span class="cm"> Usage:
</span><span class="cm"> 
</span><span class="cm"> \```
</span><span class="cm"> 
</span><span class="cm"> @SmartPublished(&#34;someKey&#34;)
</span><span class="cm"> var myProp = &#34;Bonjoir !&#34;
</span><span class="cm"> \```
</span><span class="cm"> The string property will be backed in UserDefaults.standard for the key &#34;someKey&#34;. It will be effectively stored only if the value of the var is affected after its initialization, until then UserDefaults entry will stay
</span><span class="cm"> untouched.
</span><span class="cm"> The initial value of the property will be `&#34;Bonjoir !&#34;` if there&#39;s not value in the store.
</span><span class="cm"> 
</span><span class="cm"> \```
</span><span class="cm"> @SmartPublished(&#34;myCodableValueUserDefaultsKey&#34;)
</span><span class="cm"> var myProp = someValueOfCodableType
</span><span class="cm"> \```
</span><span class="cm"> 
</span><span class="cm"> The codables are stored the same way except they are JSON encoded if they&#39;re not natively handled by UserDefaults.
</span><span class="cm"> 
</span><span class="cm"> \```
</span><span class="cm"> @SmartPublished(sendAfterStore = true)
</span><span class="cm"> var myProp = 8
</span><span class="cm"> 
</span><span class="cm"> $myProp.sink {
</span><span class="cm"> print(&#34;property: \(myProp), received: \($0)&#34;)
</span><span class="cm"> }
</span><span class="cm"> 
</span><span class="cm"> myProp = 1
</span><span class="cm"> 
</span><span class="cm"> \```
</span><span class="cm"> 
</span><span class="cm"> Will print `property: 1, received: 1`, while with `@Published` or `sendAfterStore = false` it would be `property: 8, received: 1`.
</span><span class="cm"> It is not recommended to use this `sendAfterStore = true` for UI-bound properties.
</span><span class="cm"> 
</span><span class="cm"> \```
</span><span class="cm"> @SmartPublished
</span><span class="cm"> \```
</span><span class="cm"> 
</span><span class="cm"> Why would you do that, just use `@Published` then!
</span><span class="cm"> 
</span><span class="cm"> */</span>
<span class="p">@</span><span class="n">propertyWrapper</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SmartPublished</span><span class="p">&lt;</span><span class="n">Value</span><span class="p">&gt;</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">key</span><span class="p">:</span> <span class="nb">String</span><span class="p">?</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">storage</span><span class="p">:</span> <span class="n">UserDefaults</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">sendAfterStore</span><span class="p">:</span> <span class="nb">Bool</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">subject</span><span class="p">:</span> <span class="n">CurrentValueSubject</span><span class="p">&lt;</span><span class="n">Value</span><span class="p">,</span> <span class="n">Never</span><span class="p">&gt;</span>
    <span class="kd">private</span> <span class="kd">var</span> <span class="nv">val</span><span class="p">:</span> <span class="n">Value</span>
    <span class="kd">private</span> <span class="kd">var</span> <span class="nv">storingMapper</span><span class="p">:</span> <span class="p">(</span><span class="n">Value</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="nb">Any</span><span class="p">?</span>
    <span class="kd">private</span> <span class="kd">var</span> <span class="nv">storeReadingMapper</span><span class="p">:</span> <span class="p">(</span><span class="nb">Any</span><span class="p">?)</span> <span class="p">-&gt;</span> <span class="n">Value</span><span class="p">?</span>
    
    <span class="kd">private</span> <span class="kd">init</span><span class="p">(</span><span class="n">wrappedValue</span> <span class="n">value</span><span class="p">:</span> <span class="n">Value</span><span class="p">,</span>
                 <span class="kc">_</span> <span class="n">key</span><span class="p">:</span> <span class="nb">String</span><span class="p">?</span> <span class="p">,</span>
                 <span class="n">storage</span><span class="p">:</span> <span class="n">UserDefaults</span><span class="p">,</span>
                 <span class="n">sendAfterStore</span><span class="p">:</span> <span class="nb">Bool</span><span class="p">,</span>
                 <span class="n">storingMapper</span><span class="p">:</span> <span class="p">@</span><span class="n">escaping</span> <span class="n">StoringMapper</span><span class="p">&lt;</span><span class="n">Value</span><span class="p">&gt;,</span>
                 <span class="n">storeReadingMapper</span><span class="p">:</span> <span class="p">@</span><span class="n">escaping</span> <span class="n">StoreReadingMapper</span><span class="p">&lt;</span><span class="n">Value</span><span class="p">&gt;)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nv">initValue</span> <span class="p">=</span> <span class="n">value</span>
        <span class="k">if</span> <span class="kd">let</span> <span class="nv">key</span> <span class="p">=</span> <span class="n">key</span><span class="p">,</span> <span class="kd">let</span> <span class="nv">storedValue</span> <span class="p">=</span> <span class="n">storeReadingMapper</span><span class="p">(</span><span class="n">storage</span><span class="p">.</span><span class="n">object</span><span class="p">(</span><span class="n">forKey</span><span class="p">:</span> <span class="n">key</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">initValue</span> <span class="p">=</span> <span class="n">storedValue</span>
        <span class="p">}</span>
        <span class="n">val</span> <span class="p">=</span> <span class="n">initValue</span>
        <span class="n">subject</span> <span class="p">=</span> <span class="n">CurrentValueSubject</span><span class="p">(</span><span class="n">initValue</span><span class="p">)</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">key</span> <span class="p">=</span> <span class="n">key</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">storage</span> <span class="p">=</span> <span class="n">storage</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">sendAfterStore</span> <span class="p">=</span> <span class="n">sendAfterStore</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">storingMapper</span> <span class="p">=</span> <span class="n">storingMapper</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">storeReadingMapper</span> <span class="p">=</span> <span class="n">storeReadingMapper</span>
        <span class="n">subject</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="kd">public</span> <span class="kr">convenience</span> <span class="kd">init</span><span class="p">(</span><span class="n">wrappedValue</span> <span class="n">value</span><span class="p">:</span> <span class="n">Value</span><span class="p">,</span>
                            <span class="kc">_</span> <span class="n">key</span><span class="p">:</span> <span class="nb">String</span><span class="p">?</span> <span class="p">=</span> <span class="kc">nil</span><span class="p">,</span>
                            <span class="n">storage</span><span class="p">:</span> <span class="n">UserDefaults</span> <span class="p">=</span> <span class="p">.</span><span class="n">standard</span><span class="p">,</span>
                            <span class="n">sendAfterStore</span><span class="p">:</span> <span class="nb">Bool</span> <span class="p">=</span> <span class="kc">false</span><span class="p">)</span> <span class="k">where</span> <span class="n">Value</span><span class="p">:</span> <span class="n">UserDefaultsStorable</span> <span class="p">{</span>
        <span class="kc">self</span><span class="p">.</span><span class="kd">init</span><span class="p">(</span><span class="n">wrappedValue</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span>
                  <span class="n">key</span><span class="p">,</span> <span class="n">storage</span><span class="p">:</span> <span class="n">storage</span><span class="p">,</span>
                  <span class="n">sendAfterStore</span><span class="p">:</span> <span class="n">sendAfterStore</span><span class="p">,</span>
                  <span class="n">storingMapper</span><span class="p">:</span> <span class="p">{</span><span class="nv">$0</span><span class="p">},</span>
                  <span class="n">storeReadingMapper</span><span class="p">:</span> <span class="p">{</span> <span class="nv">$0</span> <span class="k">as</span><span class="p">?</span> <span class="n">Value</span><span class="p">})</span>
    <span class="p">}</span>
    
    <span class="kd">public</span> <span class="kr">convenience</span> <span class="kd">init</span><span class="p">(</span><span class="n">wrappedValue</span> <span class="n">value</span><span class="p">:</span> <span class="n">Value</span><span class="p">,</span>
                            <span class="kc">_</span> <span class="n">key</span><span class="p">:</span> <span class="nb">String</span><span class="p">?,</span>
                            <span class="n">storage</span><span class="p">:</span> <span class="n">UserDefaults</span> <span class="p">=</span> <span class="p">.</span><span class="n">standard</span><span class="p">,</span>
                            <span class="n">sendAfterStore</span><span class="p">:</span> <span class="nb">Bool</span> <span class="p">=</span> <span class="kc">false</span><span class="p">)</span> <span class="k">where</span> <span class="n">Value</span> <span class="p">:</span> <span class="n">Codable</span> <span class="p">{</span>
        <span class="kc">self</span><span class="p">.</span><span class="kd">init</span><span class="p">(</span><span class="n">wrappedValue</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span>
                  <span class="n">key</span><span class="p">,</span>
                  <span class="n">storage</span><span class="p">:</span> <span class="n">storage</span><span class="p">,</span>
                  <span class="n">sendAfterStore</span><span class="p">:</span> <span class="n">sendAfterStore</span><span class="p">,</span>
                  <span class="n">storingMapper</span><span class="p">:</span> <span class="p">{</span><span class="nv">$0</span><span class="p">.</span><span class="n">mapForStorage</span><span class="p">()},</span>
                  <span class="n">storeReadingMapper</span><span class="p">:</span> <span class="n">Value</span><span class="p">.</span><span class="n">mapOutOfStorage</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="kd">public</span> <span class="kr">convenience</span> <span class="kd">init</span><span class="p">(</span><span class="n">wrappedValue</span> <span class="n">value</span><span class="p">:</span> <span class="n">Value</span><span class="p">,</span>
                            <span class="kc">_</span> <span class="n">key</span><span class="p">:</span> <span class="nb">String</span><span class="p">?,</span>
                            <span class="n">storage</span><span class="p">:</span> <span class="n">UserDefaults</span> <span class="p">=</span> <span class="p">.</span><span class="n">standard</span><span class="p">,</span>
                            <span class="n">sendAfterStore</span><span class="p">:</span> <span class="nb">Bool</span> <span class="p">=</span> <span class="kc">false</span><span class="p">)</span> <span class="k">where</span> <span class="n">Value</span> <span class="p">:</span> <span class="n">Codable</span> <span class="o">&amp;</span> <span class="n">UserDefaultsStorable</span> <span class="p">{</span>
        <span class="kc">self</span><span class="p">.</span><span class="kd">init</span><span class="p">(</span><span class="n">wrappedValue</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span>
                  <span class="n">key</span><span class="p">,</span> <span class="n">storage</span><span class="p">:</span> <span class="n">storage</span><span class="p">,</span>
                  <span class="n">sendAfterStore</span><span class="p">:</span> <span class="n">sendAfterStore</span><span class="p">,</span>
                  <span class="n">storingMapper</span><span class="p">:</span> <span class="p">{</span><span class="nv">$0</span><span class="p">},</span>
                  <span class="n">storeReadingMapper</span><span class="p">:</span> <span class="p">{</span> <span class="nv">$0</span> <span class="k">as</span><span class="p">?</span> <span class="n">Value</span><span class="p">})</span>
    <span class="p">}</span>
    
    <span class="kd">public</span> <span class="kr">convenience</span> <span class="kd">init</span><span class="p">(</span><span class="n">wrappedValue</span> <span class="n">value</span><span class="p">:</span> <span class="n">Value</span><span class="p">,</span> <span class="n">sendAfterStore</span><span class="p">:</span> <span class="nb">Bool</span> <span class="p">=</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
        <span class="kc">self</span><span class="p">.</span><span class="kd">init</span><span class="p">(</span><span class="n">wrappedValue</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span>
                  <span class="kc">nil</span><span class="p">,</span>
                  <span class="n">storage</span><span class="p">:</span> <span class="p">.</span><span class="n">standard</span><span class="p">,</span>
                  <span class="n">sendAfterStore</span><span class="p">:</span> <span class="n">sendAfterStore</span><span class="p">,</span>
                  <span class="n">storingMapper</span><span class="p">:</span> <span class="p">{</span><span class="nv">$0</span><span class="p">},</span>
                  <span class="n">storeReadingMapper</span><span class="p">:</span> <span class="p">{</span><span class="nv">$0</span> <span class="k">as</span><span class="p">?</span> <span class="n">Value</span><span class="p">})</span>
    <span class="p">}</span>
    
    <span class="kd">public</span> <span class="kd">var</span> <span class="nv">wrappedValue</span><span class="p">:</span> <span class="n">Value</span> <span class="p">{</span>
        <span class="kr">set</span> <span class="p">{</span>
            <span class="k">if</span> <span class="n">sendAfterStore</span> <span class="p">{</span>
                <span class="n">subject</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">newValue</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="kd">let</span> <span class="nv">key</span> <span class="p">=</span> <span class="kc">self</span><span class="p">.</span><span class="n">key</span> <span class="p">{</span>
                <span class="n">storage</span><span class="p">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">storingMapper</span><span class="p">(</span><span class="n">newValue</span><span class="p">),</span> <span class="n">forKey</span><span class="p">:</span> <span class="n">key</span><span class="p">)</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">val</span> <span class="p">=</span> <span class="n">newValue</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="o">!</span><span class="n">sendAfterStore</span> <span class="p">{</span>
                <span class="n">subject</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">newValue</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="kr">get</span> <span class="p">{</span>
            <span class="k">if</span> <span class="kd">let</span> <span class="nv">key</span> <span class="p">=</span> <span class="kc">self</span><span class="p">.</span><span class="n">key</span> <span class="p">{</span>
                <span class="k">return</span> <span class="n">storeReadingMapper</span><span class="p">(</span><span class="n">storage</span><span class="p">.</span><span class="n">value</span><span class="p">(</span><span class="n">forKey</span><span class="p">:</span> <span class="n">key</span><span class="p">))</span> <span class="p">??</span> <span class="n">val</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="n">val</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="kd">public</span> <span class="kd">var</span> <span class="nv">projectedValue</span><span class="p">:</span> <span class="n">CurrentValueSubject</span><span class="p">&lt;</span><span class="n">Value</span><span class="p">,</span> <span class="n">Never</span><span class="p">&gt;</span> <span class="p">{</span>
        <span class="kr">get</span> <span class="p">{</span> <span class="n">subject</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>N&rsquo;hésitez pas à me contacter pour toute remarque, insulte ou éloge, mon email est dans le footer ;)</p>

            </div>

            
    
    
        <ul class="post-copyright">
            <li class="copyright-item author"><span class="copyright-item-text">Auteur</span> : <a href="https://pittscraft.com/about/" class="p-author h-card" target="_blank" rel="noopener">Pitt</a></li>
            
                
                
                
                
                <li class="copyright-item link"><span class="copyright-item-text">Lien</span> : <a href="/posts/swiftui_combine2/" target="_blank" rel="noopener">https://pittscraft.com/posts/swiftui_combine2/</a></li>
            
            
        </ul>
    



        </article>

        

        
    <div class="updated-badge-container">
        <span title="Updated @ 2020-12-10 14:14:35 CET" style="cursor:help">

<svg xmlns="http://www.w3.org/2000/svg" width="130" height="20" class="updated-badge"><linearGradient id="b" x2="0" y2="100%"><stop offset="0" stop-color="#bbb" stop-opacity=".1"/><stop offset="1" stop-opacity=".1"/></linearGradient><clipPath id="a"><rect width="130" height="20" rx="3" fill="#fff"/></clipPath><g clip-path="url(#a)"><path class="updated-badge-left" d="M0 0h55v20H0z"/><path class="updated-badge-right" d="M55 0h75v20H55z"/><path fill="url(#b)" d="M0 0h130v20H0z"/></g><g fill="#fff" text-anchor="middle" font-size="110"><text x="285" y="150" fill="#010101" fill-opacity=".3" textLength="450" transform="scale(.1)">updated</text><text x="285" y="140" textLength="450" transform="scale(.1)">updated</text><text x="915" y="150" fill="#010101" fill-opacity=".3" textLength="650" transform="scale(.1)">2020-12-10</text><text x="915" y="140" textLength="650" transform="scale(.1)">2020-12-10</text></g></svg>
        </span></div>



        


        <div class="post-share">

        

        <div class="share-items">

            
                <div class="share-item twitter">
                    
                    <a href="https://twitter.com/share?url=https://pittscraft.com/posts/swiftui_combine2/&amp;text=SwiftUI%20&amp;%20Combine%20Feedback%20#2%20:%20property%20wrapper%20pour%20UserDefaults%20et%20@Published&amp;hashtags=iOS,Combine,SwiftUI,&amp;via=reuixiy" title="Partage sur Twitter" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon twitter-icon"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg></a>
                </div>
            

            
                <div class="share-item facebook">
                    
                    <a href="https://www.facebook.com/sharer/sharer.php?u=https://pittscraft.com/posts/swiftui_combine2/&amp;hashtag=%23iOS" title="Partage sur Facebook" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon facebook-icon"><path d="M504 256C504 119 393 8 256 8S8 119 8 256c0 123.78 90.69 226.38 209.25 245V327.69h-63V256h63v-54.64c0-62.15 37-96.48 93.67-96.48 27.14 0 55.52 4.84 55.52 4.84v61h-31.28c-30.8 0-40.41 19.12-40.41 38.73V256h68.78l-11 71.69h-57.78V501C413.31 482.38 504 379.78 504 256z"/></svg></a>
                </div>
            

            
                <div class="share-item linkedin">
                    
                    <a href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://pittscraft.com/posts/swiftui_combine2/&amp;title=SwiftUI%20&amp;%20Combine%20Feedback%20#2%20:%20property%20wrapper%20pour%20UserDefaults%20et%20@Published&amp;summary=J%e2%80%99avais%20d%c3%a9j%c3%a0%20crois%c3%a9%20un%20exemple%20d%e2%80%99impl%c3%a9mentation%20de%20property%20wrapper%20et%20devant%20leur%20simplicit%c3%a9,%20je%20m%e2%80%99%c3%a9tais%20mis%20en%20t%c3%aate%20de%20cr%c3%a9er%20un%20property%20wrapper%20acc%c3%a9l%c3%a9rant%20le%20stockage%20de%20valeurs%20dans%20les%20UserDefaults.%0aIl%20se%20trouve%20que%20dans%20mes%20exp%c3%a9rimentations%20autour%20de%20Combine%20j%e2%80%99avais%20bien%20envie%20de%20cr%c3%a9er%20un%20wrapper%20publiant%20les%20nouvelles%20valeurs%20seulement%20apr%c3%a8s%20les%20avoirs%20stock%c3%a9es%20%28voir%20ici%29.&amp;source=Pitt%27s%20Craft" title="Partage sur LinkedIn" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon linkedin-icon"><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg></a>
                </div>
            

            
                <div class="share-item telegram">
                    
                    <a href="https://t.me/share/url?url=https://pittscraft.com/posts/swiftui_combine2/&amp;text=SwiftUI%20&amp;%20Combine%20Feedback%20#2%20:%20property%20wrapper%20pour%20UserDefaults%20et%20@Published" title="Partage sur Telegram" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512" class="icon telegram-icon"><path d="M248 8C111 8 0 119 0 256s111 248 248 248 248-111 248-248S385 8 248 8zm121.8 169.9l-40.7 191.8c-3 13.6-11.1 16.9-22.4 10.5l-62-45.7-29.9 28.8c-3.3 3.3-6.1 6.1-12.5 6.1l4.4-63.1 114.9-103.8c5-4.4-1.1-6.9-7.7-2.5l-142 89.4-61.2-19.1c-13.3-4.2-13.6-13.3 2.8-19.7l239.1-92.2c11.1-4 20.8 2.7 17.2 19.5z"/></svg></a>
                </div>
            

            

            

            

            

            

        </div>

    </div>




        
    
    
        <div class="related-posts">
            <h2 class="related-title">Lire aussi : <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon related-icon"><path d="M256 8C119 8 8 119 8 256s111 248 248 248 248-111 248-248S393 8 256 8zm144 276c0 6.6-5.4 12-12 12h-92v92c0 6.6-5.4 12-12 12h-56c-6.6 0-12-5.4-12-12v-92h-92c-6.6 0-12-5.4-12-12v-56c0-6.6 5.4-12 12-12h92v-92c0-6.6 5.4-12 12-12h56c6.6 0 12 5.4 12 12v92h92c6.6 0 12 5.4 12 12v56z"/></svg></h2>
            <ul class="related-list">
                
                    <li class="related-item">
                        <a href="/posts/swiftui_combine1/" class="related-link">SwiftUI &amp; Combine Feedback #1 : architecture et grains de sable</a>
                    </li>
                
                    <li class="related-item">
                        <a href="/posts/attestation-ios/" class="related-link">Attestation 2s iOS</a>
                    </li>
                
            </ul>
        </div>
    



        
    
        <div class="post-tags">
            
                
                
                
                
                    
                    <a href="/tags/ios/" rel="tag" class="post-tags-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon tag-icon"><path d="M0 252.118V48C0 21.49 21.49 0 48 0h204.118a48 48 0 0 1 33.941 14.059l211.882 211.882c18.745 18.745 18.745 49.137 0 67.882L293.823 497.941c-18.745 18.745-49.137 18.745-67.882 0L14.059 286.059A48 48 0 0 1 0 252.118zM112 64c-26.51 0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.49-48-48-48z"/></svg>iOS</a>
                
            
                
                
                
                
                    
                    <a href="/tags/combine/" rel="tag" class="post-tags-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon tag-icon"><path d="M0 252.118V48C0 21.49 21.49 0 48 0h204.118a48 48 0 0 1 33.941 14.059l211.882 211.882c18.745 18.745 18.745 49.137 0 67.882L293.823 497.941c-18.745 18.745-49.137 18.745-67.882 0L14.059 286.059A48 48 0 0 1 0 252.118zM112 64c-26.51 0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.49-48-48-48z"/></svg>Combine</a>
                
            
                
                
                
                
                    
                    <a href="/tags/swiftui/" rel="tag" class="post-tags-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon tag-icon"><path d="M0 252.118V48C0 21.49 21.49 0 48 0h204.118a48 48 0 0 1 33.941 14.059l211.882 211.882c18.745 18.745 18.745 49.137 0 67.882L293.823 497.941c-18.745 18.745-49.137 18.745-67.882 0L14.059 286.059A48 48 0 0 1 0 252.118zM112 64c-26.51 0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.49-48-48-48z"/></svg>SwiftUI</a>
                
            
        </div>
    



        


        


        
    
        
        
    
    
    
    
        <ul class="post-nav">
            
            
                <li class="post-nav-next">
                    <a href="/posts/swiftui_combine1/" rel="next">SwiftUI &amp; Combine Feedback #1 : architecture et grains de sable &gt;</a>
                </li>
            
        </ul>
    



        


    </div>
</main>


            
    <div id="back-to-top" class="back-to-top">
        <a href="#"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon arrow-up"><path d="M34.9 289.5l-22.2-22.2c-9.4-9.4-9.4-24.6 0-33.9L207 39c9.4-9.4 24.6-9.4 33.9 0l194.3 194.3c9.4 9.4 9.4 24.6 0 33.9L413 289.4c-9.5 9.5-25 9.3-34.3-.4L264 168.6V456c0 13.3-10.7 24-24 24h-32c-13.3 0-24-10.7-24-24V168.6L69.2 289.1c-9.3 9.8-24.8 10-34.3.4z"/></svg></a>
    </div>


            
    <footer id="footer" class="footer">
        <div class="footer-inner">
            <div class="site-info">©&nbsp;2020–2021&nbsp;Pitt</div><div class="site-copyright"></div><div class="custom-footer">Little Pouillé EURL</div>

            
    
        <ul class="socials"><li class="socials-item">
                    <a href="/rss.xml" target="_blank" rel="external noopener" title="RSS"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="icon social-icon"><path d="M19.199 24C19.199 13.467 10.533 4.8 0 4.8V0c13.165 0 24 10.835 24 24h-4.801zM3.291 17.415c1.814 0 3.293 1.479 3.293 3.295 0 1.813-1.485 3.29-3.301 3.29C1.47 24 0 22.526 0 20.71s1.475-3.294 3.291-3.295zM15.909 24h-4.665c0-6.169-5.075-11.245-11.244-11.245V8.09c8.727 0 15.909 7.184 15.909 15.91z"/></svg></a>
                </li><li class="socials-item">
                    <a href="mailto:pitt@pittscraft.com" target="_blank" rel="external noopener" title="Email"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon social-icon"><path d="M464 64H48C21.49 64 0 85.49 0 112v288c0 26.51 21.49 48 48 48h416c26.51 0 48-21.49 48-48V112c0-26.51-21.49-48-48-48zm0 48v40.805c-22.422 18.259-58.168 46.651-134.587 106.49-16.841 13.247-50.201 45.072-73.413 44.701-23.208.375-56.579-31.459-73.413-44.701C106.18 199.465 70.425 171.067 48 152.805V112h416zM48 400V214.398c22.914 18.251 55.409 43.862 104.938 82.646 21.857 17.205 60.134 55.186 103.062 54.955 42.717.231 80.509-37.199 103.053-54.947 49.528-38.783 82.032-64.401 104.947-82.653V400H48z"/></svg></a>
                </li><li class="socials-item">
                    <a href="https://github.com/PittsCraft" target="_blank" rel="external noopener" title="GitHub"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="icon social-icon"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a>
                </li></ul>
    



            
        </div>
    </footer>


        </div>
        

        








    <script src="https://cdn.jsdelivr.net/npm/medium-zoom@latest/dist/medium-zoom.min.js"></script>

<script>
    mediumZoom(document.querySelectorAll('div.post-body img'), {
        background: 'hsla(var(--color-bg-h), var(--color-bg-s), var(--color-bg-l), 0.95)'
    })
</script>









    </body>
</html>
